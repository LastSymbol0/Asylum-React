import styles from './header.module.scss'
import { useLocales } from '../../hooks/useLocales'

import { scrollTo } from '../../utils/scrollTo'
import Link from 'next/link'
import { useState, useRef, useEffect } from 'react'

import { useRouter } from 'next/router'
import renderer from '../../utils/renderer'

import Icons from '../UI/icons/icons'
import TheMenu from './menu/menu'

const state = {
    isScrolling: false
}

const Header = () => {
    const locale = useLocales('components.header')
    const [ activeNumber, setActiveNumber ] = useState(0)
    const [ offsetX, setOffsetX ] = useState(0)
    const [ dimension, setDimension ] = useState({ x: 0 })

    const nav = useRef()
    const navButtons = useRef([])
    useEffect(() => {
        const parentLeft = renderer.getElementCoords(nav.current).left
        const elementLeft = renderer.getElementCoords(navButtons.current[activeNumber]).left
        setOffsetX(elementLeft - parentLeft)
        window.addEventListener('resize', resize)
        return () => window.removeEventListener('resize', resize)
    }, [ activeNumber, dimension ])
    
    function resize() { setDimension({ x: window.innerWidth }) }

    const router = useRouter()
    function setScreen(target, i) {
        if (router.pathname !== '/') {
            router.push('/')
            router.events.on('routeChangeComplete', () => {
                setActiveNumber(i)
                state.isScrolling = true
                setTimeout(function() {
                    state.isScrolling = false
                }, 1000)
                setTimeout(function() {
                    scrollTo(target)
                }, 100)
            })
            return
        }
        setActiveNumber(i)
        scrollTo(target)
        state.isScrolling = true
        setTimeout(function() {
            state.isScrolling = false
        }, 1000)
    }

    useEffect(() => {
        if (router.pathname === '/team') {
            setActiveNumber(2)
        }
    })


    useEffect(() => {
        const label = `controlActiveNumber${Date.now()}`
        renderer.setToRender({
            label,
            handler: () => controlActiveNumber(),
            renderDelay: 10
        })
        return () => renderer.removeFromRender(label)
    })
    function controlActiveNumber() {
        locale.nav.forEach((_, i) => {
            if (state.isScrolling) { return }
            const element = document.querySelector(_.link)
            if (!element) { return }
            const coords = renderer.getElementCoords(element)
            if (i === 0 && coords.bottom - window.innerHeight / 8 > window.scrollY) {
                setActiveNumber(i)
                return
            }
            if (coords.bottom - window.innerHeight / 8 <= window.scrollY) {
                if (element.getBoundingClientRect().height !== 0) {
                    if (i === locale.nav.length - 1) {
                        setActiveNumber(i)
                        return
                    }
                    const nextElement = document.querySelector(locale.nav[i + 1].link)
                    if (nextElement) { 
                       if (nextElement.getBoundingClientRect().height === 0) {
                            setActiveNumber(i + 2)
                            return
                       } 
                    }
                    setActiveNumber(i + 1)
                }
            }
        })
    }

    return (
        <header className={styles.header}>
            <Link href="/">
                <a className={styles.header__logo}>
                    <svg width="121" height="27" viewBox="0 0 121 27" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M78.6163 9.24578C78.6163 14.6315 78.6882 17.3058 78.8139 17.7329C79.3167 19.2558 80.538 20.2401 82.2261 20.4444L83.1061 20.5558V19.2558V17.9744L82.5135 17.7515C82.1723 17.6215 81.8131 17.3244 81.7053 17.0458C81.5437 16.7301 81.4898 14.3344 81.4898 8.98578V1.3715H80.0531H78.6163V9.24578Z" fill="white"/>
                        <path d="M38.6572 2.89433C36.8972 8.26147 33.5567 19.5715 33.6286 19.9058C33.7184 20.2772 33.8261 20.3143 35.0653 20.3143H36.3943L36.969 18.3643L37.5437 16.4143H41.0816H44.6196L45.1943 18.3643L45.769 20.3143H47.098C48.3551 20.3143 48.4449 20.2772 48.5347 19.8872C48.6065 19.59 47.7445 16.5443 46.0743 11.1029L43.4882 2.76433L41.1176 2.70861C39.3037 2.67147 38.729 2.70861 38.6572 2.89433ZM42.5543 9.46862C43.2188 11.6043 43.7576 13.4058 43.7576 13.48C43.7755 13.5729 42.5543 13.6286 41.0637 13.6286C38.8008 13.6286 38.3698 13.5915 38.4416 13.3686C38.4955 13.22 39.0343 11.4929 39.6449 9.50576C40.2376 7.53719 40.7763 5.81004 40.8123 5.68004C41.0457 5.01147 41.4408 5.88433 42.5543 9.46862Z" fill="white"/>
                        <path d="M53.24 7.20299C51.8392 7.72299 51.1568 8.91156 51.1388 10.8058C51.1388 13.3873 52.36 14.4087 55.9698 14.8358C56.8139 14.9287 57.227 15.0773 57.5502 15.4116C58.071 15.9501 58.089 16.8416 57.6041 17.343C57.2808 17.6773 57.0114 17.7144 54.1919 17.7144H51.1388V18.5316C51.1388 19.2373 51.2106 19.4044 51.7674 19.8501L52.4139 20.3516L55.4131 20.2773C58.8433 20.203 59.4719 20.0173 60.2441 18.8101C60.7829 17.9558 60.9984 16.0987 60.6751 15.0587C60.1543 13.4616 59.3821 12.9787 56.6523 12.4958C54.3894 12.1058 54.0123 11.8644 54.0123 10.8244C54.0123 9.67299 54.3535 9.54299 57.5502 9.54299H60.298V8.72585C60.298 8.00156 60.2261 7.87156 59.6155 7.42585C58.951 6.96156 58.8433 6.94299 56.4188 6.94299C54.7845 6.96156 53.689 7.05442 53.24 7.20299Z" fill="white"/>
                        <path d="M63.4229 7.22152C63.3331 7.44438 64.7878 12.2544 67.7151 21.3915L68.0922 22.5429L67.5355 24.3258C67.2123 25.3101 67.0147 26.2201 67.0686 26.3687C67.1404 26.5544 67.4996 26.6287 68.4874 26.6287H69.7984L70.3551 24.8272C70.6604 23.8244 72.0074 19.5158 73.3543 15.2444C74.6833 10.9729 75.7249 7.37009 75.671 7.20295C75.5812 6.98009 75.2939 6.94295 74.2702 6.98009L72.9592 7.03581L71.3429 12.3658C70.4629 15.3187 69.6367 17.7144 69.5469 17.7144C69.4392 17.7144 68.631 15.3187 67.751 12.3658L66.1347 7.03581L64.8237 6.98009C63.782 6.94295 63.5127 6.98009 63.4229 7.22152Z" fill="white"/>
                        <path d="M86.5184 12.2729C86.5184 17.0829 86.5543 17.6958 86.8596 18.3829C87.2188 19.2 87.8653 19.7572 88.8351 20.0915C89.2302 20.24 90.9004 20.3143 93.4506 20.3143H97.4735V13.6286V6.9429H96.0367H94.6V12.3286V17.7143H92.391C89.1224 17.7143 89.3918 18.2158 89.3918 12.0315V6.9429H87.9551H86.5184V12.2729Z" fill="white"/>
                        <path d="M101.784 13.6286V20.3143H103.31H104.837V14.9286V9.5429H107.261H109.686V14.9286V20.3143H111.212H112.739V14.9286V9.5429H114.876C116.582 9.5429 117.085 9.59862 117.3 9.84005C117.552 10.0815 117.588 10.8429 117.588 15.2258V20.3143H119.132H120.677L120.605 14.9658C120.533 9.09719 120.479 8.7629 119.402 7.81576C119.096 7.55576 118.54 7.24005 118.162 7.12862C117.749 7.01719 114.499 6.9429 109.65 6.9429H101.784V13.6286Z" fill="white"/>
                        <path d="M7.56911 0.0196277C7.55139 0.029459 7.5258 0.0668178 7.51201 0.10221C7.49626 0.137603 7.46673 0.210355 7.44113 0.26541C7.41751 0.318499 7.33875 0.505293 7.2659 0.678323C7.04539 1.20528 6.68508 2.05077 6.65555 2.11369C6.64177 2.14515 6.59648 2.25133 6.55711 2.34964C6.51576 2.44599 6.4626 2.57379 6.437 2.63082C6.41141 2.68784 6.38975 2.73896 6.38975 2.74289C6.38975 2.74682 6.36809 2.79795 6.3425 2.85497C6.3169 2.91199 6.20665 3.1676 6.09836 3.42125C5.23402 5.45239 4.09601 8.03802 3.45612 9.42816C3.42068 9.50288 3.2927 9.78602 3.17063 10.0574C3.04856 10.3267 2.92058 10.6099 2.88514 10.6866C2.8497 10.7613 2.76504 10.9481 2.6981 11.0995C2.62919 11.2509 2.54059 11.4455 2.50121 11.5321C2.45987 11.6186 2.37127 11.8132 2.30432 11.9646C2.23541 12.116 2.03262 12.5624 1.85148 12.9576C1.41439 13.9132 1.44195 13.8522 1.29035 14.1865C1.2175 14.3477 1.1289 14.5424 1.09346 14.6191C1.05802 14.6938 1.01077 14.8 0.985173 14.855C0.961547 14.9081 0.916262 15.0064 0.886729 15.0713C0.112959 16.7505 -0.0110806 17.0356 0.000732685 17.0985C0.0145149 17.1772 0.0755502 17.2244 0.162181 17.2244C0.231092 17.2244 0.662277 17.0867 1.46755 16.8056C1.73335 16.7131 2.15469 16.5676 2.40277 16.4811C3.01312 16.2688 4.98594 15.5825 5.47422 15.4115C5.6908 15.3368 6.08457 15.1991 6.35037 15.1067C6.88985 14.9219 7.19502 14.8137 7.47264 14.7174C7.6774 14.6446 8.66578 14.3005 9.30369 14.0803C9.56162 13.9899 9.7211 13.925 9.74866 13.8955C9.79001 13.8542 9.87073 13.6379 10.17 12.7806C10.2468 12.5584 10.3315 12.3205 10.357 12.2497C10.426 12.0629 10.5165 11.8054 10.6228 11.4927C10.676 11.3413 10.7508 11.125 10.7902 11.011C11.1131 10.0947 11.686 8.40374 11.8337 7.92398C11.8593 7.84336 11.9381 7.58971 12.0109 7.36359C12.1468 6.93102 12.3417 6.30575 12.385 6.15435C12.3988 6.10519 12.448 5.94592 12.4933 5.80042C12.5386 5.65492 12.5878 5.49368 12.6035 5.44059C12.6547 5.2715 12.6843 5.16729 12.9166 4.40438C13.0406 3.98753 13.1627 3.59035 13.1824 3.52153C13.2336 3.35636 13.2316 3.33473 13.1686 3.26592C13.0721 3.16367 11.5246 2.15302 10.8197 1.73027C10.4456 1.50612 9.5498 1.00472 9.11665 0.776636C8.99852 0.713716 8.8922 0.656695 8.88039 0.64883C8.81935 0.605572 7.64787 -3.48464e-05 7.62621 -3.48464e-05C7.61243 -3.48464e-05 7.58683 0.00979643 7.56911 0.0196277Z" fill="white"/>
                        <path d="M24.4149 3.51964C23.3399 3.62386 23.2139 3.63565 22.83 3.67694C21.879 3.77526 21.0619 3.89323 20.2212 4.0525C19.3864 4.2098 18.778 4.32974 18.7229 4.34744C18.6047 4.3848 18.5929 4.41429 18.5555 4.78395C18.3744 6.51818 18.1578 8.73415 18.1046 9.42234C18.0889 9.6229 18.0475 10.2049 17.9964 10.9324C17.9727 11.2687 17.9078 12.3245 17.8881 12.6726C17.8782 12.8771 17.8644 13.0992 17.8585 13.1641C17.8546 13.229 17.8448 13.3922 17.8388 13.5279C17.8329 13.6636 17.8231 13.8169 17.8192 13.872C17.8132 13.9251 17.8054 14.0627 17.7995 14.1767C17.7798 14.5661 17.7502 15.15 17.7404 15.3073C17.7325 15.4352 17.7365 15.4745 17.764 15.5177C17.7837 15.5472 17.9452 15.7006 18.1243 15.8599C18.3035 16.0191 18.6047 16.2865 18.7938 16.4556C19.7782 17.3346 20.8729 18.3137 21.373 18.7581C21.6821 19.0334 22.0936 19.3991 22.2865 19.5741C23.3576 20.5297 25.039 22.0241 25.1178 22.089C25.3127 22.2482 25.3265 22.2581 25.3934 22.2581C25.4407 22.2581 25.4761 22.2423 25.5096 22.2069C25.5529 22.1597 25.5569 22.144 25.5529 21.9572C25.547 21.68 25.5096 20.5848 25.4978 20.3213C25.4939 20.2014 25.484 19.9497 25.4781 19.7609C25.4722 19.5722 25.4584 19.1651 25.4486 18.8564C25.4387 18.5477 25.421 18.0267 25.4092 17.6963C25.3875 17.0141 25.3738 16.6031 25.36 16.2217C25.3541 16.0762 25.3403 15.6377 25.3304 15.2484C25.3206 14.859 25.3068 14.452 25.3009 14.3439C25.297 14.2357 25.2871 13.9487 25.2812 13.7048C25.2753 13.461 25.2655 13.174 25.2615 13.0658C25.2576 12.9577 25.2477 12.6175 25.2418 12.3088C25.2359 12.0001 25.2261 11.6914 25.2221 11.6206C25.2182 11.5498 25.2084 11.135 25.2025 10.6965C25.1966 10.258 25.1887 9.78413 25.1828 9.64453C25.1769 9.50296 25.169 8.72039 25.1611 7.90439C25.1552 7.0884 25.1473 6.31369 25.1434 6.18392C25.1395 6.05415 25.1355 5.40922 25.1355 4.75249L25.1335 3.557L25.0843 3.50981C25.0587 3.48229 25.0253 3.46262 25.0115 3.46262C24.9977 3.46459 24.7299 3.49015 24.4149 3.51964Z" fill="white"/>
                    </svg>
                </a>
            </Link>
            <nav ref={nav}>
                {locale.nav.map((_, i) => (
                    <a 
                        key={i} 
                        onClick={() => { setScreen(_.link, i) }}
                        className={activeNumber === i ? styles.active : ''}
                        ref={(r) => navButtons.current.push(r)}
                    >
                        { _.title }
                    </a>
                ))}
                <div style={{left: `${offsetX}px`}} className={styles.header__activeLine}></div>
            </nav>
            <div className={styles.header__social}>
                {locale.social.map((_, i) => (
                    <a key={i} href={ _.link } target="_blank" rel="noreferrer">
                        <Icons label={ _.title }/>
                    </a>
                ))}
            </div>
            <TheMenu 
                className={styles.header__menu} 
                activeNumber={activeNumber}
                setScreen={setScreen}
                setActiveNumber={setActiveNumber}
            />
        </header>
    )
}

export default Header